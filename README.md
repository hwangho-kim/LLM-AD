오토인코더 및 SHAP 기반 RCA 시스템 구현 상세 해설서
1. 개요: 코드의 목적과 전체 흐름
본 문서는 오토인코더 및 SHAP 기반 FDC 분석 모델 (피처 강화) 파이썬 코드의 전체 구현 과정을 상세히 설명합니다. 이 시스템의 목표는 레이블이 없는 대규모 반도체 제조 데이터를 활용하여, (1) 공정 이상을 자동으로 탐지하고, (2) 그 근본 원인이 되는 공정 파라미터를 엔지니어가 이해할 수 있도록 설명하는 것입니다.

전체 파이프라인은 다음 4단계로 구성됩니다.

데이터 생성: 실제와 유사한 FDC 시계열 데이터와 MES 데이터를 시뮬레이션합니다.

특징 공학 (Feature Engineering): 원본 시계열 데이터로부터 통계적/도메인적 특징을 추출하여 분석용 정형 데이터로 변환합니다.

이상 탐지 (Anomaly Detection): 오토인코더 딥러닝 모델을 사용하여 데이터의 '비정상' 패턴을 탐지합니다.

원인 분석 (Root Cause Analysis): SHAP(XAI) 기술을 이용해 모델이 왜 특정 데이터를 '비정상'으로 판단했는지 그 원인을 설명합니다.

2. 1단계: 현실적인 샘플 데이터 생성
모든 데이터 분석의 시작은 데이터 확보입니다. generate_wafer_data 함수는 실제 팹(Fab) 환경을 모사하여, 분석에 필요한 두 가지 핵심 데이터를 생성합니다.

2.1. 생성되는 데이터의 종류

MES (Manufacturing Execution System) 데이터: mes_df 데이터프레임

역할: 공정의 컨텍스트(Context) 정보를 제공합니다. "언제, 어디서, 어떻게" 공정이 진행되었는지를 알려줍니다.

주요 컬럼:

wafer_id: 웨이퍼 고유 ID

equipment_id: 공정을 수행한 장비 ID (예: Etcher_A)

recipe_id: 공정에 사용된 레시피 ID (예: Recipe_1)

anomaly_type: 시뮬레이션을 위한 이상 유형 정보 (실제 데이터에는 없음)

final_yield: 최종 수율 정보 (1: 정상, 0: 불량) - 모델 평가를 위한 레이블

FDC (Fault Detection and Classification) 데이터: fdc_data 딕셔너리

역할: 공정이 진행되는 동안 장비 내부에서 실제로 무슨 일이 있었는지를 보여주는 시계열 데이터입니다.

구조: 각 wafer_id를 키로 가지며, 내부에 센서별(pressure, rf_power 등) 시계열(100개 타임스텝) Numpy 배열을 값으로 가집니다.

2.2. 이상(Anomaly) 데이터 시뮬레이션

현실성을 높이기 위해, 전체 데이터의 약 20%에 고의로 세 가지 유형의 이상을 주입합니다.

Spike: 특정 시점에 센서 값이 순간적으로 급등하거나 급락하는 현상. (예: RF 파워 불안정)

Variance: 공정 중 센서 값의 변동성이 비정상적으로 커지는 현상. (예: 가스 유량 제어 불안)

Drift: 센서 값이 시간이 지남에 따라 서서히 증가하거나 감소하는 현상. (예: 챔버 온도 변화)

이러한 다양한 유형의 이상 데이터는 모델이 특정 패턴에만 과적합되지 않고, 여러 종류의 문제를 탐지할 수 있도록 훈련하는 데 도움을 줍니다.

3. 2단계: 시계열 특징 공학 (Feature Engineering)
원본 시계열 데이터(Raw Time-Series)는 정보가 풍부하지만, 머신러닝 모델이 직접 학습하기에는 비효율적입니다. feature_engineering_enhanced 함수는 이 시계열 데이터를 모델이 학습하기 좋은 '정형 데이터'로 요약 및 변환하는 핵심적인 역할을 합니다.

3.1. 피처(Feature)란?

피처는 데이터의 특징을 나타내는 개별 변수를 의미합니다. 여기서는 100개의 타임스텝으로 이루어진 시계열을 단 몇 개의 숫자(피처)로 요약하여 그 특성을 대표하도록 합니다.

3.2. 강화된 피처 목록 (총 10종)

각 센서(pressure, rf_power 등)의 시계열마다 아래 10개의 피처를 추출하여 총 40개의 동적 피처를 생성합니다. (4개 센서 x 10개 피처)

기본 통계 피처 (6종)

_mean: 평균값. 공정 중 파라미터의 평균 레벨을 나타냅니다.

_std: 표준편차. 파라미터의 안정성/변동성을 나타내는 핵심 지표입니다. (값이 클수록 불안정)

_max / _min: 최댓값/최솟값. 공정 중 발생한 극단적인 값을 포착합니다.

_skew: 왜도. 데이터 분포의 비대칭성. 갑작스러운 스파이크 발생 시 값이 변할 수 있습니다.

_kurt: 첨도. 분포의 뾰족함. 극단적인 이상치(Outlier)의 존재 유무를 나타냅니다.

도메인 특화 피처 (4종)

_stable_std: 공정 안정 구간의 표준편차. 전체 공정 중 가장 중요한 안정 구간(20%~80%)의 변동성만 따로 측정하여, 공정 핵심 단계의 안정성을 정밀하게 평가합니다.

_auc (Area Under Curve): 곡선 아래 면적. 공정 시간 동안 가해진 총 에너지량, 주입된 총 가스량 등 '총량'의 개념을 나타냅니다.

_slope: 선형 추세(기울기). 공정 전반에 걸쳐 파라미터가 서서히 증가하거나 감소하는 드리프트(Drift) 현상을 정량적으로 포착합니다.

_peak_count: 피크(Spike) 개수. 평균에서 3-시그마(3x표준편차)를 벗어나는 값이 몇 번이나 발생했는지 카운트하여, 스파이크 이상의 빈도를 직접적으로 측정합니다.

이러한 강화된 피처들은 "압력이 높았다"라는 단편적인 정보를 넘어, "공정 안정 구간에서 RF 파워의 변동성이 비정상적으로 컸고, 드리프트 현상이 관찰되었다" 와 같이 훨씬 더 구체적이고 다각적인 분석을 가능하게 합니다.

4. 3단계: 오토인코더를 이용한 이상 탐지
이 단계는 시스템의 핵심 엔진으로, 비지도 학습(Unsupervised Learning)을 통해 '정상'의 기준을 학습하고, 그 기준에서 벗어나는 데이터를 '이상'으로 탐지합니다.

4.1. 데이터 전처리

모델이 최적의 성능을 내기 위해 데이터를 가공하는 과정입니다. ColumnTransformer를 사용하여 두 가지 작업을 동시에 수행합니다.

Min-Max 스케일링: 모든 수치형 피처들을 0과 1 사이의 값으로 변환합니다. 이는 각 피처의 단위나 크기에 상관없이 모델이 동등한 중요도로 학습하게 만듭니다.

원-핫 인코딩: Etcher_A, Recipe_1과 같은 범주형 데이터를 모델이 이해할 수 있는 0과 1로 이루어진 벡터로 변환합니다.

4.2. 오토인코더 모델

핵심 원리: 오토인코더는 정상 데이터만을 학습하여, 입력된 정상 데이터를 압축(인코딩)했다가 다시 원본과 똑같이 복원(디코딩)하는 방법을 배웁니다.

'정상'의 기준 학습: 이 과정을 통해 모델은 수십 개의 피처들 간의 복잡한 비선형 관계, 즉 **'정상 공정의 디지털 지문'**을 학습하게 됩니다.

이상 탐지: 학습이 끝난 모델에 새로운 데이터를 입력했을 때,

정상 데이터: 학습한 패턴과 유사하므로 복원이 잘 됩니다. (낮은 복원 오류)

이상 데이터: 학습한 패턴에서 벗어나므로 복원이 제대로 되지 않습니다. (높은 복원 오류)
이 '복원 오류(Reconstruction Error)' 값을 **이상 점수(Anomaly Score)**로 사용합니다.

4.3. 학습 및 평가

autoencoder.fit(): 정상 데이터(X_train_scaled)만을 사용하여 모델을 학습시킵니다. 이것이 비지도 학습의 핵심입니다.

임계치(Threshold) 설정: 학습된 정상 데이터들의 복원 오류 중 상위 1%(99 분위수) 값을 임계치로 설정합니다. 이 값을 넘어가는 복원 오류를 가진 데이터는 '이상'으로 판단합니다.

평가: classification_report와 confusion_matrix를 통해 모델의 성능을 평가합니다.

정밀도(Precision): 모델이 "이상"이라고 한 것 중, 진짜 "이상"인 비율. (FP를 줄이는 게 중요할 때)

재현율(Recall): 실제 "이상" 중에서, 모델이 "이상"으로 찾아낸 비율. (FN을 줄이는 게 중요할 때)

F1-Score: 정밀도와 재현율의 조화 평균. 두 지표를 균형 있게 볼 때 사용합니다.

5. 4단계: SHAP을 이용한 근본 원인 분석
모델이 "이상"이라고 알려주는 것만으로는 부족합니다. 엔지니어는 "왜?" 이상인지 알아야 실질적인 조치를 취할 수 있습니다. 4단계는 이 "왜?"에 대한 답을 제공하는 과정입니다.

5.1. SHAP (SHapley Additive exPlanations)

SHAP은 특정 예측 결과에 대해 각 피처가 얼마나, 그리고 어떤 방향으로 기여했는지를 정량적으로 설명해주는 강력한 XAI(설명가능 AI) 도구입니다.

5.2. 분석 결과 해석

Force Plot (개별 분석):

목적: 이상으로 탐지된 하나의 샘플에 대한 상세 분석.

해석:

base value: 모든 데이터의 평균적인 예측값(평균 이상 점수).

빨간색 막대: 이상 점수를 높이는 데 기여한 피처들. 이것이 바로 근본 원인 후보입니다.

파란색 막대: 이상 점수를 낮추는 데 기여한 피처들.

막대의 길이는 기여도의 크기를 나타냅니다.

예를 들어, pressure_std 피처가 긴 빨간색 막대로 나타났다면, "이 웨이퍼가 이상으로 탐지된 가장 큰 이유는 압력의 표준편차(변동성)가 비정상적으로 높았기 때문입니다." 라고 해석할 수 있습니다.

Summary Plot (종합 분석):

목적: 여러 이상 샘플들을 종합하여, 어떤 피처가 전반적으로 중요한지 파악.

해석:

Y축: 피처의 중요도 순서 (위에 있을수록 중요).

X축: SHAP 값 (0을 기준으로 오른쪽에 있으면 이상 점수를 높이는 영향, 왼쪽은 낮추는 영향).

점의 색상: 피처의 값 (빨간색은 높은 값, 파란색은 낮은 값).

예를 들어, rf_power_stable_std가 Y축 상단에 있고, 오른쪽에 주로 빨간 점들이 분포한다면, "우리 시스템에서는 전반적으로 안정 구간에서 RF 파워의 변동성(std)이 높은 것(빨간색)이 이상을 유발하는 주요 원인이다." 라는 강력한 통찰을 얻을 수 있습니다.

6. 결론
본 파이썬 코드는 단순히 이상을 탐지하는 것을 넘어, 피처 공학을 통해 데이터의 잠재력을 최대한 끌어내고, 오토인코더로 비지도 학습을 수행하며, 최종적으로 SHAP을 통해 엔지니어가 실제 조치를 취할 수 있는 **'실행 가능한 통찰력(Actionable Insight)'**을 제공하는 통합적인 RCA 시스템의 구현체입니다. 이 파이프라인은 실제 반도체 팹의 복잡하고 레이블 없는 데이터를 효과적으로 분석하기 위한 현실적인 청사진을 제시합니다.

