** 오토인코더 및 SHAP 기반 RCA 시스템 구현 상세 해설서 **

** 1. 개요: 코드의 목적과 전체 흐름 **

본 문서는 오토인코더 및 SHAP 기반 FDC 분석 모델 (피처 강화) 파이썬 코드의 전체 구현 과정을 상세히 설명합니다. 이 시스템의 목표는 레이블이 없는 대규모 반도체 제조 데이터를 활용하여, (1) 공정 이상을 자동으로 탐지하고, (2) 그 근본 원인이 되는 공정 파라미터를 엔지니어가 이해할 수 있도록 설명하는 것입니다.

** 시스템 전체 파이프라인 **

시스템은 아래와 같이 명확한 4단계의 파이프라인으로 구성되어, 데이터로부터 실행 가능한 통찰력(Actionable Insight)을 추출합니다.

+--------------------------+      +--------------------------+      +--------------------------+      +----------------------------+
|        1. 데이터 생성      |----->|      2. 특징 공학        |----->|       3. 이상 탐지       |----->|        4. 원인 분석        |
|  (Data Generation)       |      | (Feature Engineering)    |      |  (Anomaly Detection)     |      |   (Root Cause Analysis)    |
+--------------------------+      +--------------------------+      +--------------------------+      +----------------------------+
| - FDC 시계열 데이터      |      | - 통계/도메인 피처 추출  |      | - 오토인코더 모델 학습   |      | - SHAP 기여도 분석         |
| - MES 컨텍스트 데이터    |      | - 정형 데이터로 변환     |      | - '이상 점수' 계산       |      | - Force & Summary Plots    |
+--------------------------+      +--------------------------+      +--------------------------+      +----------------------------+

** 2. 1단계: 현실적인 샘플 데이터 생성 **

모든 데이터 분석의 시작은 데이터 확보입니다. generate_wafer_data 함수는 실제 팹(Fab) 환경을 모사하여, 분석에 필요한 두 가지 핵심 데이터를 생성합니다.

** 2.1. 생성되는 데이터의 종류 **

MES 데이터 (mes_df)

역할: 공정 컨텍스트 제공. "언제, 어디서, 어떻게" 공정이 진행되었는지에 대한 정보를 담습니다.

주요 정보: wafer_id, equipment_id, recipe_id, final_yield

FDC 데이터 (fdc_data)

역할: 공정 상태 데이터. 공정 중 장비 내부 센서(온도, 압력 등)의 시계열 데이터를 제공합니다.

주요 정보: pressure, rf_power, gas_flow, temperature의 시계열

** 2.2. 이상(Anomaly) 데이터 시뮬레이션 **

현실성을 높이기 위해, 전체 데이터의 약 20%에 고의로 아래와 같은 세 가지 유형의 이상을 주입합니다.

Spike

설명: 특정 시점에 센서 값이 순간적으로 급등/급락하는 현상.

예시 상황: RF 파워 불안정

Variance

설명: 공정 중 센서 값의 변동성(분산)이 비정상적으로 커지는 현상.

예시 상황: 가스 유량 제어 불안

Drift

설명: 센서 값이 시간이 지남에 따라 서서히 증가하거나 감소하는 현상.

예시 상황: 챔버 온도 변화

** 3. 2단계: 시계열 특징 공학 (Feature Engineering) **

원본 시계열 데이터는 정보가 풍부하지만, 머신러닝 모델이 직접 학습하기에는 비효율적입니다. 이 단계는 100개의 타임스텝을 가진 시계열을 몇 개의 핵심 숫자(피처)로 요약하여 데이터의 특성을 압축하고 명확하게 만듭니다.

** 강화된 피처 목록 (센서당 총 10종) **

기본 통계 피처 (6종)

_mean, _std, _max, _min, _skew, _kurt: 평균, 표준편차, 최대/최소, 왜도, 첨도. 시계열의 기본적인 분포와 통계적 특성을 파악합니다.

도메인 특화 피처 (4종)

_stable_std: 안정 구간(20%~80%)의 표준편차. 공정 핵심 단계의 안정성을 정밀하게 평가합니다.

_auc: 곡선 아래 면적(Area Under Curve). 공정 중 가해진 총 에너지/가스량을 나타냅니다.

_slope: 선형 추세(기울기). 공정 전반의 점진적 변화(드리프트)를 포착합니다.

_peak_count: 피크(Spike) 개수. 평균에서 3-시그마를 벗어나는 이상 신호의 빈도를 측정합니다.

이러한 강화된 피처들은 "압력이 높았다"라는 단편적 정보를 넘어, "공정 안정 구간에서 RF 파워의 변동성이 비정상적으로 컸고, 드리프트 현상이 관찰되었다" 와 같이 훨씬 더 구체적이고 다각적인 분석을 가능하게 합니다.

** 4. 3단계: 오토인코더를 이용한 이상 탐지 **

이 단계는 시스템의 핵심 엔진으로, 비지도 학습(Unsupervised Learning)을 통해 '정상'의 기준을 학습하고, 그 기준에서 벗어나는 데이터를 '이상'으로 탐지합니다.

** 4.1. 데이터 전처리 **

ColumnTransformer를 사용하여 모든 피처를 모델이 학습하기 좋은 형태로 변환합니다.

Min-Max 스케일링: 모든 수치형 피처를 0~1 사이로 정규화합니다.

원-핫 인코딩: Etcher_A와 같은 범주형 데이터를 [1, 0, 0] 과 같은 숫자 벡터로 변환합니다.

** 4.2. 오토인코더 모델 아키텍처 **

핵심 원리: 정상 데이터만을 학습하여, 입력 데이터를 저차원으로 압축(인코딩)했다가 다시 원본과 똑같이 복원(디코딩)하는 방법을 배웁니다. 이 과정을 통해 모델은 **'정상 공정의 디지털 지문'**을 학습합니다.

이상 탐지: 학습된 패턴과 다른 '이상 데이터'가 들어오면 제대로 복원하지 못해 **복원 오류(Reconstruction Error)**가 커집니다. 이 오류 값을 **이상 점수(Anomaly Score)**로 사용합니다.

** 4.3. 학습 및 평가 **

모델 학습: autoencoder.fit() 함수로 정상 데이터만을 사용하여 모델을 학습시킵니다. (핵심 포인트: 비지도 학습)

임계치 설정: 학습된 정상 데이터들의 복원 오류 중 상위 1%(99 분위수) 값을 임계치로 설정합니다. (핵심 포인트: 통계 기반의 합리적 기준 설정)

성능 평가: classification_report를 통해 정밀도(Precision), 재현율(Recall), F1-Score를 계산합니다. (핵심 포인트: 불균형 데이터에 적합한 지표 사용)

** 5. 4단계: SHAP을 이용한 근본 원인 분석 **

모델이 "이상"이라고 알려주는 것만으로는 부족합니다. 엔지니어는 "왜?" 이상인지 알아야 실질적인 조치를 취할 수 있습니다. SHAP(SHapley Additive exPlanations)은 이 "왜?"에 대한 명확한 답을 제공하는 강력한 XAI(설명가능 AI) 도구입니다.

** 분석 결과 해석 예시 **

Force Plot (개별 샘플 분석)

목적: 이상으로 탐지된 하나의 샘플에 대한 상세 원인 분석.

해석: pressure_std 피처가 긴 빨간색 막대로 나타났다면, "이 웨이퍼가 이상으로 탐지된 가장 큰 이유는 압력의 표준편차(변동성)가 비정상적으로 높았기 때문"이라고 해석할 수 있습니다. 빨간색 피처들이 바로 근본 원인 후보입니다.

Summary Plot (종합 패턴 분석)

목적: 여러 이상 샘플들을 종합하여, 어떤 피처가 전반적으로 중요한지 파악.

해석: Y축 상단에 위치한 피처일수록 전반적인 이상 탐지에 큰 영향을 미치는 중요한 변수임을 의미합니다. 점의 색상은 해당 피처 값의 높낮이를 나타냅니다.

** 6. 결론 **

본 파이썬 코드는 단순히 이상을 탐지하는 것을 넘어, 피처 공학을 통해 데이터의 잠재력을 최대한 끌어내고, 오토인코더로 비지도 학습을 수행하며, 최종적으로 SHAP을 통해 엔지니어가 실제 조치를 취할 수 있는 '실행 가능한 통찰력(Actionable Insight)' 을 제공하는 통합적인 RCA 시스템의 구현체입니다. 이 파이프라인은 실제 반도체 팹의 복잡하고 레이블 없는 데이터를 효과적으로 분석하기 위한 현실적인 청사진을 제시합니다.

